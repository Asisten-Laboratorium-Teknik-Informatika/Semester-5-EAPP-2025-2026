<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Resep Saya</title>
    <link rel="stylesheet" href="style.css">
    <script src="/eel.js"></script>
    <style>
        /* Container Utama Filter */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Baris Search & Tombol Fav */
        .top-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-box {
            flex: 1;
            padding: 12px 15px;
            font-size: 16px;
            border: 2px solid #eee;
            border-radius: 8px;
            outline: none;
            transition: 0.3s;
        }
        .search-box:focus { border-color: #e67e22; }

        /* Tombol Filter Favorit */
        .btn-fav-filter {
            padding: 0 20px;
            background: white;
            border: 2px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-fav-filter.active {
            border-color: #e74c3c;
            color: #e74c3c;
            background: #fff5f5;
        }

        /* Area Kategori Chips */
        .category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .cat-chip {
            padding: 6px 15px;
            background: #f4f4f9;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            user-select: none;
        }

        .cat-chip:hover { background: #e0e0e0; }

        /* Kategori Aktif */
        .cat-chip.active {
            background: #e67e22;
            color: white;
            box-shadow: 0 2px 5px rgba(230, 126, 34, 0.3);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Recipe.ID</h2>
        <div class="menu-item" onclick="window.location.href='index.html'">Dashboard</div>
        <div class="menu-item active" onclick="window.location.href='recipes.html'">Resep Saya</div>
        <div class="menu-item" onclick="window.location.href='add.html'">Tambah Resep</div>
                <div class="menu-item" onclick="window.location.href='planner.html'">Rencana Masak</div>
        <div class="menu-item" onclick="window.location.href='categories.html'">Kelola Kategori</div>
    </div>
    
    <div class="main-content">
        <div class="header"><h1>üìñ Koleksi Resep Saya</h1></div>
        
        <div class="filter-section">
            <div class="top-controls">
                <input type="text" id="cariInput" class="search-box" placeholder="üîç Cari nama resep..." onkeyup="jalankanFilter()">
                <button id="btnFav" class="btn-fav-filter" onclick="toggleFilterFav()">
                    <span>‚ù§Ô∏è</span> Favorit
                </button>
            </div>

            <div style="font-size:12px; color:#888; margin-bottom:5px;">Filter Kategori:</div>
            <div id="cat-filters-container" class="category-filters">
                Loading Kategori...
            </div>
        </div>

        <div class="recipe-grid" id="grid">Loading Resep...</div>
        <p id="no-result" style="display:none; text-align:center; color:#777; margin-top: 50px;">Resep tidak ditemukan.</p>
    </div>

    <script>
        let semuaResep = []; 
        let filterFavoritAktif = false;
        let kategoriTerpilih = []; // Array untuk menyimpan nama kategori yang dipilih

        async function initPage() {
            // 1. Ambil Data Kategori untuk Filter
            let kategoriData = await eel.ambil_kategori()();
            renderFilterKategori(kategoriData);

            // 2. Ambil Data Resep
            semuaResep = await eel.ambil_semua_resep()();
            tampilkanResep(semuaResep);
        }

        // --- RENDER TOMBOL KATEGORI ---
        function renderFilterKategori(data) {
            let container = document.getElementById('cat-filters-container');
            let html = '';
            
            if(data.length === 0) {
                html = '<span style="color:#ccc; font-style:italic;">Belum ada kategori.</span>';
            } else {
                data.forEach(c => {
                    // Kita pakai 'onclick' untuk memanggil fungsi toggle
                    html += `<div class="cat-chip" onclick="toggleKategori(this, '${c.name}')">${c.name}</div>`;
                });
            }
            container.innerHTML = html;
        }

        // --- LOGIC KLIK KATEGORI ---
        function toggleKategori(element, namaKategori) {
            // Cek apakah sudah ada di array?
            if (kategoriTerpilih.includes(namaKategori)) {
                // Kalau sudah ada -> Hapus (Unselect)
                kategoriTerpilih = kategoriTerpilih.filter(k => k !== namaKategori);
                element.classList.remove('active');
            } else {
                // Kalau belum ada -> Tambah (Select)
                kategoriTerpilih.push(namaKategori);
                element.classList.add('active');
            }
            // Jalankan filter ulang setiap kali klik
            jalankanFilter();
        }

        // --- LOGIC KLIK FAVORIT ---
        function toggleFilterFav() {
            filterFavoritAktif = !filterFavoritAktif;
            let btn = document.getElementById('btnFav');
            
            if(filterFavoritAktif) btn.classList.add('active');
            else btn.classList.remove('active');
            
            jalankanFilter();
        }

        // --- LOGIC FILTER UTAMA (GABUNGAN SEMUA) ---
        function jalankanFilter() {
            let keyword = document.getElementById('cariInput').value.toLowerCase();
            
            let hasilFilter = semuaResep.filter(r => {
                // 1. Cek Nama (Search)
                let matchNama = r.title.toLowerCase().includes(keyword);
                
                // 2. Cek Favorit
                let matchFav = true;
                if (filterFavoritAktif) {
                    matchFav = (r.is_favorite === 1);
                }

                // 3. Cek Kategori (Multi-select Logic)
                // Logic: Resep harus punya SETIDAKNYA SATU dari kategori yang dipilih (OR Logic)
                // Kalau tidak ada kategori yang dipilih, maka tampilkan semua (True)
                let matchKat = true;
                
                if (kategoriTerpilih.length > 0) {
                    // r.category_name isinya string misal: "Pedas, Sarapan"
                    // Kita cek apakah string tersebut mengandung salah satu dari kategori terpilih
                    if (r.category_name) {
                        // Cek apakah ada irisan antara kategori resep dan kategori terpilih
                        // Kita pakai 'some' -> minimal satu cocok
                        matchKat = kategoriTerpilih.some(kat => r.category_name.includes(kat));
                    } else {
                        // Kalau resep tidak punya kategori sama sekali, tapi filter aktif -> False
                        matchKat = false;
                    }
                }

                return matchNama && matchFav && matchKat;
            });

            tampilkanResep(hasilFilter);
            document.getElementById('no-result').style.display = (hasilFilter.length === 0) ? 'block' : 'none';
        }

        // --- RENDER KARTU RESEP ---
        function tampilkanResep(data) {
            let grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            if(data.length === 0) return; // Pesan no-result dihandle di jalankanFilter
            
            data.forEach(r => {
                let img = r.image_path ? `<img src="${r.image_path}" style="width:100%; height:150px; object-fit:cover;">` : `<div class="card-img-placeholder">üç≥</div>`;
                let favIcon = (r.is_favorite === 1) ? `<div class="fav-icon">‚ù§Ô∏è</div>` : '';
                
                // Deskripsi Scrollable
                let deskripsi = r.description ? r.description : 'Tidak ada deskripsi.';

                grid.innerHTML += `
                <div class="recipe-card" onclick="window.location.href='detail.html?id=${r.id}'">
                    ${favIcon}
                    ${img}
                    <div class="card-body">
                        <div class="card-title">${r.title}</div>
                        <span class="badge">${r.category_name || '-'}</span>
                        <div class="desc-box">${deskripsi}</div>
                    </div>
                </div>`;
            });
        }

        initPage();
    </script>
</body>
</html>