<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="/eel.js"></script>
</head>

<body>
    <div class="sidebar">
        <h2>Recipe.ID</h2>
        <div class="menu-item active">Dashboard</div>
        <div class="menu-item" onclick="window.location.href='recipes.html'">Resep Saya</div>
        <div class="menu-item" onclick="window.location.href='add.html'">Tambah Resep</div>
        <div class="menu-item" onclick="window.location.href='planner.html'">Rencana Masak</div>
        <div class="menu-item" onclick="window.location.href='categories.html'">Kelola Kategori</div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1 id="greeting">Halo! üëã</h1>
            <p style="color:#7f8c8d;">Status Database: <span id="db-status" style="font-weight:bold;">Loading...</span>
            </p>
        </div>

        <div class="stats-container">
            <div class="stat-card" id="card-resep">
                <div>
                    <h3>Total Resep</h3>
                    <h1 id="cnt-resep" style="color:#e67e22;">0</h1>
                </div>
                <div class="stat-icon">üç≥</div>
            </div>
            <div class="stat-card" id="card-kategori">
                <div>
                    <h3>Kategori</h3>
                    <h1 id="cnt-kategori" style="color:#3498db;">0</h1>
                </div>
                <div class="stat-icon">üè∑Ô∏è</div>
            </div>
            <div class="stat-card" id="card-favorit">
                <div>
                    <h3>Favorit</h3>
                    <h1 id="cnt-favorit" style="color:#e74c3c;">0</h1>
                </div>
                <div class="stat-icon">‚ù§Ô∏è</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div>
                <h3 style="margin-bottom:15px; color:#34495e;">üí° Rekomendasi Spesial</h3>
                <div class="carousel-container">
                    <button class="carousel-btn prev-btn" onclick="geserSlide(-1)">&#10094;</button>
                    <button class="carousel-btn next-btn" onclick="geserSlide(1)">&#10095;</button>
                    <div class="carousel-track" id="track">
                        <div class="carousel-slide">
                            <div
                                style="height:100%; display:flex; align-items:center; justify-content:center; background:#eee; color:#aaa;">
                                Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="horizontal-section">
                    <h3 style="margin-bottom:10px; color:#34495e;">üç™ Ide Cemilan</h3>
                    <div class="horizontal-scroll" id="scroll-cemilan">
                        <p style="color:#aaa; font-size:12px;">Belum ada resep cemilan.</p>
                    </div>
                </div>

                <div class="horizontal-section">
                    <h3 style="margin-bottom:10px; color:#34495e;">ü•§ Seger-segeran (Minuman)</h3>
                    <div class="horizontal-scroll" id="scroll-minuman">
                        <p style="color:#aaa; font-size:12px;">Belum ada resep minuman.</p>
                    </div>
                </div>
            </div>

            <div>
                <h3 style="margin-bottom:15px; color:#34495e;">üìÖ Rencana <span id="lbl-hari">Hari Ini</span></h3>
                <div class="today-plan-box" id="box-rencana">
                    <p style="color:#aaa;">Loading...</p>
                </div>

                <h3 style="margin-bottom:15px; color:#34495e;">üïí Baru Ditambahkan</h3>
                <div class="recent-list-container" id="recent-box">
                    <p style="color:#aaa; text-align:center; margin-top:50px;">Belum ada data.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let slideIndex = 0;
        let totalSlides = 0;
        let autoSlideInterval = null;
        let isAutoPaused = false;

        async function loadDashboard() {
            const jam = new Date().getHours();
            let sapaan = "Halo, ingin masak apa hari ini?";
            if (jam < 11) sapaan = "Selamat Pagi! Sarapan apa hari ini?";
            else if (jam < 15) sapaan = "Selamat Siang! Sudah makan?";
            else if (jam < 19) sapaan = "Selamat Sore! Rencana masak apa?";
            else sapaan = "Selamat Malam! Ingin masak yang simpel?";
            document.getElementById('greeting').innerText = sapaan;

            let data = await eel.ambil_data_dashboard()();
            document.getElementById('db-status').innerText = data.status;
            document.getElementById('db-status').style.color = data.status === "Terkoneksi" ? "green" : "red";

            if (data.status === "Terkoneksi") {
                document.getElementById('cnt-resep').innerText = data.stats.resep;
                document.getElementById('cnt-kategori').innerText = data.stats.kategori;
                document.getElementById('cnt-favorit').innerText = data.stats.favorit;

                renderSlider(data.rekomendasi);
                renderRencana(data.rencana_hari_ini);

                // RENDER LIST BARU
                let recentHTML = '';
                if (data.terbaru.length > 0) {
                    data.terbaru.forEach(r => {
                        let thumbUrl = r.image_path ? r.image_path : "https://via.placeholder.com/100?text=üç≥";
                        recentHTML += `
                        <div class="recent-item" onclick="window.location.href='detail.html?id=${r.id}'">
                            <img src="${thumbUrl}" class="recent-icon">
                            <div>
                                <div style="font-weight:bold; color:#2c3e50;">${r.title}</div>
                                <div style="font-size:12px; color:#95a5a6;">${r.category_name || 'Umum'}</div>
                            </div>
                        </div>`;
                    });
                    document.getElementById('recent-box').innerHTML = recentHTML;
                }

                // RENDER CEMILAN
                renderHorizontalList(data.cemilan, 'scroll-cemilan');

                // RENDER MINUMAN
                renderHorizontalList(data.minuman, 'scroll-minuman');
            }
        }

        // FUNGSI HELPER UNTUK RENDER LIST HORIZONTAL (CEMILAN/MINUMAN)
        function renderHorizontalList(dataList, containerId) {
            let container = document.getElementById(containerId);
            if (!dataList || dataList.length === 0) {
                container.innerHTML = '<p style="color:#aaa; font-size:12px; padding:10px;">Belum ada resep di kategori ini.</p>';
                return;
            }

            let html = '';
            dataList.forEach(r => {
                let img = r.image_path ? r.image_path : "https://via.placeholder.com/150?text=Food";
                html += `
                <div class="mini-card" onclick="window.location.href='detail.html?id=${r.id}'">
                    <img src="${img}">
                    <div class="mini-card-body">
                        <div class="mini-card-title" title="${r.title}">${r.title}</div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderRencana(data) {
            document.getElementById('lbl-hari').innerText = data.hari;
            let html = '';
            const waktuMakan = ['Sarapan', 'Siang', 'Malam'];
            const icons = { 'Sarapan': '‚òÄÔ∏è', 'Siang': 'üå§Ô∏è', 'Malam': 'üåô' };

            waktuMakan.forEach(w => {
                let menu = data.menu[w];
                let content = '';
                if (menu) {
                    let img = menu.image_path ? menu.image_path : "https://via.placeholder.com/50?text=üç≥";
                    content = `
                    <div class="plan-content" onclick="window.location.href='detail.html?id=${menu.id}'">
                        <img src="${img}" class="plan-thumb">
                        <div class="plan-title">${menu.title}</div>
                    </div>`;
                } else {
                    content = `<div class="plan-empty" onclick="window.location.href='planner.html'">+ Tambah Rencana</div>`;
                }
                html += `
                <div class="plan-item">
                    <div class="plan-time">${icons[w]} ${w}</div>
                    ${content}
                </div>`;
            });
            document.getElementById('box-rencana').innerHTML = html;
        }

        function renderSlider(listResep) {
            let track = document.getElementById('track');
            track.innerHTML = '';
            if (listResep.length === 0) {
                track.innerHTML = '<div class="carousel-slide"><div style="height:100%; display:flex; align-items:center; justify-content:center; background:#eee;">Belum ada resep.</div></div>';
                return;
            }
            totalSlides = listResep.length;
            listResep.forEach(r => {
                let imgUrl = r.image_path ? r.image_path : "https://via.placeholder.com/600x400?text=No+Image";
                let desc = r.description ? r.description : "Tidak ada deskripsi.";
                let html = `
                <div class="carousel-slide" onclick="bukaDetail(${r.id})">
                    <img src="${imgUrl}">
                    <div class="slide-overlay">
                        <span class="badge" style="background:#e74c3c; margin-bottom:5px;">Rekomendasi</span>
                        <h2 style="margin:0; font-size:24px;">${r.title}</h2>
                        <div class="hero-desc" style="color:#ddd; margin-top:5px; font-size:14px; max-height:50px; overflow:hidden;">${desc}</div>
                    </div>
                </div>`;
                track.innerHTML += html;
            });
            startAutoSlide();
        }

        function updateSlidePosition() {
            let track = document.getElementById('track');
            track.style.transform = `translateX(-${slideIndex * 100}%)`;
        }

        function geserSlide(arah) {
            if (!isAutoPaused) { clearInterval(autoSlideInterval); isAutoPaused = true; }
            slideIndex += arah;
            if (slideIndex >= totalSlides) slideIndex = 0;
            else if (slideIndex < 0) slideIndex = totalSlides - 1;
            updateSlidePosition();
        }

        function startAutoSlide() {
            if (isAutoPaused) return;
            if (autoSlideInterval) clearInterval(autoSlideInterval);
            autoSlideInterval = setInterval(() => {
                slideIndex++;
                if (slideIndex >= totalSlides) slideIndex = 0;
                updateSlidePosition();
            }, 3000);
        }

        function bukaDetail(id) { window.location.href = 'detail.html?id=' + id; }

        loadDashboard();
    </script>
</body>

</html>